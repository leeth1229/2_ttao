import streamlit as st
import fitz  # PyMuPDF
import streamlit_antd_components as sac
import os
import tempfile
import dataiku

st.set_page_config(
    layout="wide",
    page_title="PDF_Viewer",
    page_icon="ğŸ“‘",
)

# #Folders
FOLDER = dataiku.Folder("PPrygQ3Y")

with tempfile.TemporaryDirectory() as temp_dir:

    for path in FOLDER.list_paths_in_partition():

        if path.endswith(".pdf"):

            with FOLDER.get_download_stream(path) as f:
                full_path = os.path.join(temp_dir, os.path.basename(path))
                data = f.read()
                with open(full_path, 'wb') as f:
                    f.write(data)

    pdf_list = os.listdir(temp_dir)
    pdf_name = st.sidebar.selectbox("PDF ì„ íƒ", pdf_list)
    pdf_path = os.path.join(temp_dir, pdf_name)

    # st.write(pdf_name)
    # Download Excel ë²„íŠ¼
    # with FOLDER.get_download_stream(os.path.join("/", pdf_name)) as f:
    #     data = f.read()
    #     st.download_button(label = 'Download', data = data, file_name = pdf_name, mime = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')

    # PDF ë¬¸ì„œ ì—´ê¸°
    doc = fitz.open(pdf_path)

# ì•„ì›ƒë¼ì¸(ëª©ì°¨) ì¶”ì¶œ
outlines = doc.get_toc(simple=False)

unique_key = []
for outline in outlines:
    _ , title, page = outline[:3]
    unique_key.append({title: page})

def convert_outlines_to_tree(outlines, parent_level=1):
    tree_items = []  # This will store the converted tree items.
    while outlines:
        # Extract the first outline item
        level, title, _ = outlines[0][:3]
        
        if level < parent_level:
            # If the current level is lower than the parent's, break from the loop
            break
        elif level > parent_level:
            # If the current level is deeper, recursively process the nested items
            # Assuming the last item in the list is the parent
            if tree_items:
                tree_items[-1].children = convert_outlines_to_tree(outlines, level)
        else:
            # Remove the processed item from outlines
            outlines.pop(0)
            # Create a new TreeItem and add it to the list
            item = sac.TreeItem(title, children=[])
            tree_items.append(item)

    return tree_items

# Convert your document outlines to a tree structure
tree_items = convert_outlines_to_tree(outlines)

# ì´ˆê¸° ì„¸ì…˜ ìƒíƒœ ì„¤ì •
title = "PURPOSE"
if 'title' not in st.session_state:
    st.session_state.title = "PURPOSE"
    
page_number = 0
if 'page_number' not in st.session_state:
    st.session_state.page_number = 0
    
page_number_new = 0
if 'page_number_new' not in st.session_state:
    st.session_state.page_number_new = 0

rotation = 0
if 'rotation' not in st.session_state:
    st.session_state.rotation = 0

# Streamlit ì•± íƒ€ì´í‹€
st.title("PDF Viewer Navigation")

# ì‚¬ì´ë“œë°”ì— ì•„ì›ƒë¼ì¸ ì„ íƒ UI ê°œì„  ë° í˜ì´ì§€ ì§ì ‘ ì´ë™
with st.sidebar:
    # ì§€ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥
    st.write("## Go to Page")
    page_input = st.text_input("Enter page number:",placeholder = "clearing for page-move", value="", key="input")
    if page_input:
        try:
            page_ = int(page_input) - 1 # ì‚¬ìš©ì ì…ë ¥ì„ í˜ì´ì§€ ë²ˆí˜¸ë¡œ ë³€í™˜ (0 ê¸°ë°˜ ì¸ë±ì‹±)
            if 0 <= page_number < len(doc):
                st.session_state.page_number = page_
            else:
                st.error("Page number out of range.")
        except ValueError:
            st.error("Please enter a valid page number.")
    
    # ì•„ì›ƒë¼ì¸ ë„¤ë¹„ê²Œì´ì…˜
    st.write("## Navigation")
    
    # Use the tree_items in your sac.tree
    title = sac.tree(
        items=tree_items,
        label='PDF Outlines',
        open_all=True,
        size='md',
        checkbox_strict=True
    )
    
    # í˜„ì¬ í˜ì´ì§€ íƒ€ì´í‹€ í‘œê¸°
    if title and isinstance(title, str) == False: # íƒ€ì´í‹€ì´ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œê¸°ë˜ë©´
        st.session_state.title = title[0]
        st.write(st.session_state.title)
    else: 
        st.session_state.title = title # íƒ€ì´í‹€ì´ ë¬¸ìì—´ì´ë©´
        st.write(st.session_state.title)

    # Initialize a variable to hold the page number
    if page_input == "":
        # Search for the title in the list of dictionaries
        for unique_dict in unique_key:
            if st.session_state.title in unique_dict:
                page_number_new = unique_dict[st.session_state.title]
                break  # Exit the loop once the title is found
        if st.session_state.page_number_new != page_number_new: #ê°’ì´ ë³€ê²½ ë˜ë©´ 
            st.session_state.page_number_new = page_number_new
            st.session_state.page_number = st.session_state.page_number_new - 1
    
col1, col2 = st.columns(2)
with col1:# í˜ì´ì§€ ì´ë™ ë²„íŠ¼
    if st.button('Previous Page'):
        page_number_ = st.session_state.page_number - 1
        st.session_state.page_number = max(0, page_number_)
        # st.write(st.session_state.page_number+1)
    # í˜ì´ì§€ íšŒì „ ë²„íŠ¼
    if st.button("Rotate -90Â° :arrow_right_hook:"):
        st.session_state.rotation -= 90
    
with col2: # í˜ì´ì§€ ì´ë™ ë²„íŠ¼
    if st.button('Next Page'):
        page_number_ = st.session_state.page_number + 1
        st.session_state.page_number = min(len(doc) - 1, page_number_)
        # st.write(st.session_state.page_number+1)
    # í˜ì´ì§€ íšŒì „ ë²„íŠ¼
    if st.button("Rotate 90Â° :leftwards_arrow_with_hook:"):
        st.session_state.rotation += 90

# í˜„ì¬ í˜ì´ì§€ ë¡œë“œ ë° í‘œì‹œqq
if st.session_state.page_number is not None:
    current_page_number = st.session_state.page_number
    pages_to_show = [current_page_number]
    if current_page_number < len(doc) - 1:  # ë‹¤ìŒ í˜ì´ì§€ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì¶”ê°€
        pages_to_show.append(current_page_number + 1)

# ì´ë¯¸ì§€ ë³€í™˜ì— ì‚¬ìš©í•  ìŠ¤ì¼€ì¼ë§ ë§¤íŠ¸ë¦­ìŠ¤ ì •ì˜ (ë„ˆë¹„ í™•ì¥)
scaling_matrix = fitz.Matrix(2.0, 2.0)  # ë„ˆë¹„ì™€ ë†’ì´ë¥¼ 2ë°°ë¡œ í™•ì¥
rotation_matrix = scaling_matrix.prerotate(st.session_state.rotation)

# í˜ì´ì§€ ë³´ì´ê¸°
cols = st.columns(len(pages_to_show))
for idx, page_num in enumerate(pages_to_show):
    page = doc.load_page(page_num)
    pix = page.get_pixmap(matrix=rotation_matrix)  # ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • ì ìš©
    pix.set_dpi(pix.width, pix.height)
    image_bytes = pix.tobytes("png")
    cols[idx].image(image_bytes, caption=f"Page {page_num + 1}", use_column_width=True)


with FOLDER.get_download_stream(os.path.join("/", pdf_name)) as f:
    data = f.read()
    st.download_button(label = 'File Download', data = data, file_name = pdf_name, mime = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        
